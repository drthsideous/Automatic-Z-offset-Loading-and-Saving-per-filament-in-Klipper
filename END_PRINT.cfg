[gcode_macro END_PRINT]
description: Safe end routine with automatic Z offset save and smart confirmation message
gcode:
    M400                        ; wait for moves to finish
    G92 E0
    G1 E-1 F300                 ; retract a bit
    G91
    G1 Z10 F6000                ; lift nozzle 10mm relative
    G90

    ; üß≠ Safe dynamic park position (near back-right corner)
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    G1 X{max_x * 0.9} Y{max_y * 0.9} F6000

    M104 S0                     ; turn off hotend
    M140 S0                     ; turn off bed
    M107                        ; turn off fan

    ; üíæ Automatically save current baby-step Z offset for this filament
    SAVE_Z_ADJUST

    ; üß† Show confirmation in Mainsail console & LCD
    {% set ftype = printer["gcode_macro FILAMENT_Z_ADJUST"].filament_type|upper %}
    {% set saved_offset = printer.save_variables.variables.get(ftype ~ "_Z_OFFSET", 0.0)|float %}
    {% if saved_offset|round(3) != 0.0 %}
      {action_respond_info("‚úÖ Z offset saved for %s: %.3f mm" % (ftype, saved_offset))}
      M117 {"Z offset saved for %s: %.3f mm" % (ftype, saved_offset)}
    {% else %}
      {action_respond_info("‚ÑπÔ∏è No Z offset adjustment to save for %s" % ftype)}
      M117 Z offset unchanged for {ftype}
    {% endif %}

    M117 Print complete
