[gcode_macro FILAMENT_Z_ADJUST]
description: Dynamically adjusts Z offset based on filament type
variable_filament_type: "ASA"
gcode:
  # Prevent offset stacking across prints
  SET_GCODE_OFFSET Z=0.0

  {% set f = filament_type|lower %}
  {% set saved = printer.save_variables.variables.get(f ~ "_z_offset", 0.0)|float %}

  SET_GCODE_OFFSET Z_ADJUST={saved} MOVE=1

  M117 Z offset {saved|round(3)} for {f|upper}
  {action_respond_info("FILAMENT_Z_ADJUST ran â†’ offset %.3f for %s" % (saved, f.upper()))}